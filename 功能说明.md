# V3 新增功能说明

## 更新时间
2026年1月19日

## 新增功能

### 1. 提示词预览功能 ✨

**位置**：第一步「监控捕获流程」区域

**功能说明**：
- 当捕获或加载工作流后，系统会自动提取工作流中的提示词（prompt）
- 在「提示词预览」标签处显示提示词的**前30个字符**
- 如果提示词超过30字符，会显示"..."省略号
- 支持自动检测正面提示词和负面提示词

**使用场景**：
- 快速确认当前加载的工作流是哪个提示词配置
- 避免混淆不同的工作流配置
- 无需打开完整的workflow.json文件即可预览关键信息

**示例**：
```
💬 提示词预览: A beautiful landscape with mountains and...
```

---

### 2. 自定义输出路径功能 📁

**位置**：第一步「监控捕获流程」区域

**功能说明**：
- 允许用户自定义生成结果的保存位置
- 默认保存在「生成结果」文件夹
- 可以通过以下两种方式设置：
  1. 直接在输入框中输入路径
  2. 点击「选择文件夹」按钮，通过图形界面选择

**使用场景**：
- 将不同项目的结果保存到不同的文件夹
- 保存到外部存储设备（如移动硬盘、网络驱动器）
- 便于结果管理和分类

**默认值**：
```
📁 输出路径: 生成结果
```

**自定义示例**：
```
📁 输出路径: D:\我的项目\AI绘画\风景图
```

**结果文件夹结构**：
```
[自定义路径]/
  └── 批量生成_20260119_210530/
      ├── ComfyUI_00001_.png
      ├── ComfyUI_00002_.png
      ├── 使用的workflow.json
      └── 执行日志.txt
```

---

## 技术实现细节

### 提示词提取逻辑
1. 遍历workflow中的所有节点
2. 查找包含`text`字段的节点（正面提示词）
3. 查找包含`negative`字段的节点（负面提示词）
4. 过滤长度小于10的文本（避免干扰）
5. 优先显示第一个正面提示词的前30字符

### 输出路径处理逻辑
1. 从`custom_output_path`变量读取用户设置的路径
2. 如果为空或未设置，使用默认值"生成结果"
3. 在用户设置的基础路径下创建带时间戳的子文件夹
4. 格式：`[基础路径]/[模式名称]_[时间戳]/`

---

## 使用流程

### 完整工作流示例

1. **启动程序**
   - 运行「一体化工具-V3.bat」

2. **选择端口**
   - 点击「探测可用端口」
   - 选择ComfyUI端口（如8187）
   - 点击「确认端口」

3. **捕获或加载工作流**
   - 方式A：点击「开始监控」→ 在ComfyUI完成生图 → 点击「停止监控」
   - 方式B：点击「加载配置」→ 选择之前保存的workflow.json
   - ✨ **查看提示词预览**：系统会自动显示提示词的前30字符

4. **设置输出路径**（可选）
   - 📁 在「输出路径」框中输入自定义路径，或点击「选择文件夹」
   - 如不设置，默认保存到「生成结果」文件夹

5. **选择批量模式**
   - 批量生成：重复执行N次（comfyui通用）
   - 单图处理：处理指定图片N次
   - 文件夹批处理：批量处理文件夹中的所有图片
   - 双图融合（图片1和图片2）、单图+文件夹融合、文件夹交叉融合（文件夹1和文件夹2）

6. **开始执行**
   - 点击「开始批量」
   - 结果会保存到设置的输出路径

---

## 注意事项

### 提示词预览
- 只显示前30个字符，如需查看完整提示词，请打开保存的workflow.json文件
- 如果工作流中没有文本提示词，会显示「(未检测到提示词)」
- 支持中英文提示词

### 输出路径
- 确保设置的路径具有写入权限
- 路径可以是相对路径或绝对路径
- 如果路径不存在，系统会自动创建
- 每次执���会在设置的路径下创建带时间戳的子文件夹，避免覆盖

---

## 常见问题

**Q: 提示词预览显示「(未捕获工作流)」？**
A: 需要先捕获或加载工作流，提示词预览才会更新。

**Q: 提示词预览显示「(未检测到提示词)」？**
A: 当前工作流可能不包含文本提示词节点，或提示词字段名称不是标准的`text`或`negative`。

**Q: 自定义输出路径后，文件保存在哪里？**
A: 保存在`[自定义路径]/[模式名称]_[时间戳]/`文件夹中，例如：
   `D:\我的项目\批量生成_20260119_210530\`

**Q: 可以保存到网络驱动器吗？**
A: 可以，只要该路径有写入权限即可。

---

## 版本历史

### V3.0 (2026-01-19)
- ✨ 新增：提示词预览功能（显示前30字符）
- ✨ 新增：自定义输出路径功能
- ✨ 新增：自动在捕获/加载工作流时更新提示词预览
- 🔧 优化：输出路径可通过界面选择或手动输入

### V2.0 (之前版本)
- 基础监控和批量处理功能
- 支持多种批量模式
- 端口自动探测
- 配置保存/加载

---

## 技术支持

如有问题或建议，请查看执行日志文件或联系开发者。
